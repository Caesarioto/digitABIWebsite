<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mein Konto â€“ DigitABI</title>
<style>
  body{margin:0;font-family:Poppins,system-ui,sans-serif;color:#fff;
       background:linear-gradient(100deg,#FA565D 0%,#C45CAD 50%,#9052F8 100%);
       min-height:100vh;display:flex;flex-direction:column}
  .container{max-width:720px;margin:0 auto;padding:32px 24px;flex:1}
  h1{margin:0 0 16px;font-weight:800}
  .card{background:rgba(255,255,255,.12);backdrop-filter:blur(4px);
        border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,.3)}
  label{display:grid;gap:6px;margin:12px 0}
  input{padding:10px 12px;border-radius:10px;border:1px solid #ddd}
  button{padding:10px 14px;border-radius:12px;border:2px solid #2e1df7;
         background:#eae7ff;color:#2e1df7;font-weight:800;cursor:pointer}
  .muted{opacity:.9}
</style>
</head>
<body>

 <header>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
      :root { --link: rgba(255,255,255,.9); }
      .topnav {
        position: relative;
        display: flex;
        align-items: center;
        height: 48px;
        padding: 0 12px;
        font-family: 'Poppins', system-ui, Segoe UI, Roboto, Arial, sans-serif;
        font-weight: 700;
        letter-spacing: .04em;
        color: #fff;
      }
      .topnav .logo-link {
        display: flex;
        align-items: center;
        height: 100%;
        margin-right: 20px;
        text-decoration: none;
      }
      .topnav .nav-logo {
        height: 36px;
        width: auto;
        object-fit: contain;
      }
      .topnav .nav-links {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 28px;
        flex: 1;
      }
      .topnav .nav-links a {
        color: var(--link);
        text-decoration: none;
        white-space: nowrap;
      }
      .topnav .nav-links a:hover { text-decoration: underline; }

      .topnav .authbox {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .topnav .btn {
        padding: 7px 10px;
        border-radius: 10px;
        border: 2px solid rgba(255,255,255,.9);
        background: transparent;
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        font-size: 13px;
      }
      .topnav .btn:hover { background: rgba(255,255,255,.15); }

      .profile-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.9);
  color:#fff;
  text-decoration:none;
  background:rgba(255,255,255,.08);
}

.profile-icon:hover{
  background:rgba(255,255,255,.18);
}

.profile-icon .pi{
  font-size:18px;
  line-height:1;
}

    
      #userEmail { color:#fff; font-weight:700; font-size:14px; }

      [data-requires-auth] { display:none; }
      [data-requires-anon] { display:inline-flex; }

      /* LOGIN-DIALOG */
      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        width: min(420px, 92vw);
        background: #fff;
        color: #111;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      }
      dialog::backdrop {
        background: rgba(0,0,0,0.45);
        backdrop-filter: blur(3px);
      }
      dialog form {
        padding: 26px 22px;
        font-family: inherit;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      dialog label {
        display: grid;
        gap: 6px;
        margin-bottom: 12px;
        font-weight: 600;
        color: #222;
      }
      dialog input {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font: inherit;
      }
      dialog button[type="submit"] {
        padding: 10px 14px;
        border-radius: 10px;
        border: 2px solid #2e1df7;
        background: #eae7ff;
        color: #2e1df7;
        font-weight: 700;
        cursor: pointer;
      }
      #authMessage { margin-top:10px; color:#333; font-weight:600; }
    </style>

    <nav class="topnav" aria-label="Hauptnavigation">
      <a href="index.html" class="logo-link" aria-label="DigitABI Startseite">
        <img src="assets/place-holder.png"
             onerror="this.src='assets/logo-digitabi.png'; this.onerror=null;"
             alt=""
             class="nav-logo">
      </a>

      <div class="nav-links">
        <a href="index.html">Startseite</a>
        <a href="abirechner.html">Abibuch-Creator</a>
        <a href="steckbrief.html">Abibuch-Editor</a>
        <a href="index.html#mottos">Motto-Ideen</a>
        <a href="ueber-uns.html">Ãœber Uns</a>
        <a href="konto.html" data-requires-auth>Mein Konto</a>
      </div>

     <div class="authbox">
  <!-- Profil-Icon (nur eingeloggt sichtbar) -->
  <a href="konto.html" class="profile-icon" id="profileBtn" data-requires-auth title="Dein Profil" aria-label="Dein Profil">
    <span class="pi">ðŸ‘¤</span>
  </a>

  <button id="logoutBtn" class="btn" data-requires-auth>Logout</button>

  <!-- Nur ausgeloggt sichtbar -->
  <button class="btn" data-requires-anon data-action="open-auth">Login / Registrieren</button>
</div>


    <!-- Login / Registrieren -->
  <dialog id="authModal">
  <form id="authForm" method="dialog">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <strong style="font-size:18px">Einloggen / Registrieren</strong>
      <button type="button" id="closeAuth"
              style="background:#eee;border:none;border-radius:8px;padding:6px 10px">âœ•</button>
    </div>
    <p style="margin:8px 0 12px;color:#333">
      E-Mail und Username eingeben â€“ wir senden dir einen Magic-Link.
    </p>

    <!-- E-Mail -->
    <label>
      E-Mail
      <input name="email" type="email" required placeholder="du@example.com">
    </label>

    <!-- ðŸ‘‡ NEU: Username-Feld -->
    <label>
      Username
      <input name="display_name" type="text" required placeholder="z.B. Mulan">
    </label>

    <button type="submit"
            style="width:100%;padding:12px 14px;border-radius:12px;border:2px solid #2e1df7;background:#eae7ff;color:#2e1df7;font-weight:800;">
      Magic-Link senden
    </button>
    <div id="authMessage"></div>
  </form>
</dialog>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://xiiqcjutmvhdmmnzvciu.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_B1BShZ1r77ulTAcT8ayMdw_rON5I-O9";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const authModal = document.getElementById("authModal");

      // --- MAGIC LINK CALLBACK HANDLING ---
const fragment = new URLSearchParams(window.location.hash.slice(1));
const access_token = fragment.get("access_token");
const refresh_token = fragment.get("refresh_token");

// PrÃ¼fen ob wir von einem Magic-Link kommen
if (access_token && refresh_token) {
  try {
    const { data, error } = await supabase.auth.setSession({
      access_token,
      refresh_token
    });

    if (error) {
      console.error("Magic-Link Fehler:", error);
      alert("Login fehlgeschlagen.");
    } else {
      console.log("User erfolgreich eingeloggt:", data);

      // URL bereinigen (Token entfernen)
      window.history.replaceState({}, document.title, window.location.pathname);

      // UI aktualisieren
      await updateAuthUI(data.session);

      // OPTIONAL â†’ Direkt zum Profil:
      // window.location.href = "konto.html";
    }
  } catch (err) {
    console.error("Unerwarteter Fehler beim Magic-Link Callback:", err);
  }
}


const url = new URL(window.location.href);
  const type = url.searchParams.get("type");
  const code = url.searchParams.get("code");

  if (type && code) {
    try {
      // Supabase tauscht Code gegen Session (user wird eingeloggt)
      const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);

      if (error) {
        console.error("Auth-Callback Fehler", error);
        alert("Login mit Magic-Link ist fehlgeschlagen.");
      } else {
        // URL aufrÃ¤umen (Parameter entfernen)
        window.history.replaceState({}, document.title, window.location.pathname);

        // OPTIONAL: danach direkt auf Konto-Seite schicken
        window.location.href = "konto.html";
      }
    } catch (err) {
      console.error("Unerwarteter Fehler beim Auth-Callback", err);
    }
  }
      
      async function loadProfileName(session){
        if(!session?.user) return "";
        const { data } = await supabase
          .from("profiles")
          .select("display_name")
          .eq("id", session.user.id)
          .maybeSingle();
        return data?.display_name || session.user.email;
      }

      async function updateAuthUI(session){
        const isLoggedIn = !!session?.user;
        document.querySelectorAll("[data-requires-auth]")
          .forEach(el => el.style.display = isLoggedIn ? "" : "none");
        document.querySelectorAll("[data-requires-anon]")
          .forEach(el => el.style.display = isLoggedIn ? "none" : "");

        const span = document.getElementById("userEmail");
        if(span) span.textContent = isLoggedIn ? await loadProfileName(session) : "";
      }

      // Initialer Status
      const { data: init } = await supabase.auth.getSession();
      await updateAuthUI(init.session);
      supabase.auth.onAuthStateChange((_e, session) => updateAuthUI(session));

      // Login
      async function signInWithEmail(e){
        e.preventDefault();
        const msg = document.getElementById("authMessage");
        const email = e.currentTarget.querySelector('input[name="email"]').value.trim();
        if(!email){ msg.textContent = "Bitte E-Mail eingeben."; return; }

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: `${window.location.origin}/index.html` }
        });
        msg.textContent = error ? ("Fehler: " + error.message)
                                : "Magic-Link gesendet. Bitte Postfach prÃ¼fen âœ‰ï¸";
      }

      document.getElementById("authForm")?.addEventListener("submit", signInWithEmail);
      document.getElementById("logoutBtn")?.addEventListener("click", () => supabase.auth.signOut());
      document.querySelectorAll("[data-action='open-auth']").forEach(btn =>
        btn.addEventListener("click", () => authModal.showModal())
      );
      document.getElementById("closeAuth")?.addEventListener("click", () => authModal.close());
    </script>
  </header>

<!-- Topnav -->

<div class="container">
  <h1>Mein Konto</h1>
<div class="card">
  <div class="muted">
    Eingeloggt als: <b id="kontoEmail"></b>
  </div>


    <label> Anzeigename
      <input id="displayName" placeholder="z. B. Mulan Mustermann">
    </label>

    <label> Klassen-/Jahrgangs-Code (class_id)
      <input id="classId" placeholder="z. B. abi2026-hg-b">
    </label>

    <button id="saveBtn">Speichern</button>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div data-auth="anon">
    <p>Bitte zuerst einloggen.</p>
  </div>
</div>

 <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://xiiqcjutmvhdmmnzvciu.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_B1BShZ1r77ulTAcT8ayMdw_rON5I-O9";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      // ðŸ” Konto-Seite schÃ¼tzen
const { data: init } = await supabase.auth.getSession();

if (!init.session?.user) {
  // Nicht eingeloggt â†’ zurÃ¼ck zur Startseite
  window.location.href = "index.html";
}
   document.getElementById("kontoEmail").textContent =
  init.session.user.email;


      const authModal = document.getElementById("authModal");

      // --- MAGIC LINK CALLBACK HANDLING ---
const fragment = new URLSearchParams(window.location.hash.slice(1));
const access_token = fragment.get("access_token");
const refresh_token = fragment.get("refresh_token");

// PrÃ¼fen ob wir von einem Magic-Link kommen
if (access_token && refresh_token) {
  try {
    const { data, error } = await supabase.auth.setSession({
      access_token,
      refresh_token
    });

    if (error) {
      console.error("Magic-Link Fehler:", error);
      alert("Login fehlgeschlagen.");
    } else {
      console.log("User erfolgreich eingeloggt:", data);

      // URL bereinigen (Token entfernen)
      window.history.replaceState({}, document.title, window.location.pathname);

      // UI aktualisieren
      await updateAuthUI(data.session);

      // OPTIONAL â†’ Direkt zum Profil:
      // window.location.href = "konto.html";
    }
  } catch (err) {
    console.error("Unerwarteter Fehler beim Magic-Link Callback:", err);
  }
}


const url = new URL(window.location.href);
  const type = url.searchParams.get("type");
  const code = url.searchParams.get("code");

  if (type && code) {
    try {
      // Supabase tauscht Code gegen Session (user wird eingeloggt)
      const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);

      if (error) {
        console.error("Auth-Callback Fehler", error);
        alert("Login mit Magic-Link ist fehlgeschlagen.");
      } else {
        // URL aufrÃ¤umen (Parameter entfernen)
        window.history.replaceState({}, document.title, window.location.pathname);

        // OPTIONAL: danach direkt auf Konto-Seite schicken
        window.location.href = "konto.html";
      }
    } catch (err) {
      console.error("Unerwarteter Fehler beim Auth-Callback", err);
    }
  }
      
      async function loadProfileName(session){
        if(!session?.user) return "";
        const { data } = await supabase
          .from("profiles")
          .select("display_name")
          .eq("id", session.user.id)
          .maybeSingle();
        return data?.display_name || session.user.email;
      }

      async function updateAuthUI(session){
        const isLoggedIn = !!session?.user;
        document.querySelectorAll("[data-requires-auth]")
          .forEach(el => el.style.display = isLoggedIn ? "" : "none");
        document.querySelectorAll("[data-requires-anon]")
          .forEach(el => el.style.display = isLoggedIn ? "none" : "");

        const span = document.getElementById("userEmail");
        if(span) span.textContent = isLoggedIn ? await loadProfileName(session) : "";
      }

      // Initialer Status
      const { data: init } = await supabase.auth.getSession();
      await updateAuthUI(init.session);
      supabase.auth.onAuthStateChange((_e, session) => updateAuthUI(session));

      // Login
      async function signInWithEmail(e){
        e.preventDefault();
        const msg = document.getElementById("authMessage");
        const email = e.currentTarget.querySelector('input[name="email"]').value.trim();
        if(!email){ msg.textContent = "Bitte E-Mail eingeben."; return; }

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: `${window.location.origin}/index.html` }
        });
        msg.textContent = error ? ("Fehler: " + error.message)
                                : "Magic-Link gesendet. Bitte Postfach prÃ¼fen âœ‰ï¸";
      }

      document.getElementById("authForm")?.addEventListener("submit", signInWithEmail);
      document.getElementById("logoutBtn")?.addEventListener("click", () => supabase.auth.signOut());
      document.querySelectorAll("[data-action='open-auth']").forEach(btn =>
        btn.addEventListener("click", () => authModal.showModal())
      );
      document.getElementById("closeAuth")?.addEventListener("click", () => authModal.close());
 </script>
  
</body>
</html>
