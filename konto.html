<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mein Konto ‚Äì DigitABI</title>
<style>
  body{margin:0;font-family:Poppins,system-ui,sans-serif;color:#fff;
       background:linear-gradient(100deg,#FA565D 0%,#C45CAD 50%,#9052F8 100%);
       min-height:100vh;display:flex;flex-direction:column}
  .container{max-width:720px;margin:0 auto;padding:32px 24px;flex:1}
  h1{margin:0 0 16px;font-weight:800}
  .card{background:rgba(255,255,255,.12);backdrop-filter:blur(4px);
        border-radius:14px;padding:20px;border:1px solid rgba(255,255,255,.3)}
  label{display:grid;gap:6px;margin:12px 0}
  input{padding:10px 12px;border-radius:10px;border:1px solid #ddd}
  button{padding:10px 14px;border-radius:12px;border:2px solid #2e1df7;
         background:#eae7ff;color:#2e1df7;font-weight:800;cursor:pointer}
  .muted{opacity:.9}
</style>
</head>
<body>

 <header>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
      :root { --link: rgba(255,255,255,.9); }
      .topnav {
        position: relative;
        display: flex;
        align-items: center;
        height: 48px;
        padding: 0 12px;
        font-family: 'Poppins', system-ui, Segoe UI, Roboto, Arial, sans-serif;
        font-weight: 700;
        letter-spacing: .04em;
        color: #fff;
      }
      .topnav .logo-link {
        display: flex;
        align-items: center;
        height: 100%;
        margin-right: 20px;
        text-decoration: none;
      }
      .topnav .nav-logo {
        height: 36px;
        width: auto;
        object-fit: contain;
      }
      .topnav .nav-links {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 28px;
        flex: 1;
      }
      .topnav .nav-links a {
        color: var(--link);
        text-decoration: none;
        white-space: nowrap;
      }
      .topnav .nav-links a:hover { text-decoration: underline; }

      .topnav .authbox {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .topnav .btn {
        padding: 7px 10px;
        border-radius: 10px;
        border: 2px solid rgba(255,255,255,.9);
        background: transparent;
        color: #fff;
        font-weight: 800;
        cursor: pointer;
        font-size: 13px;
      }
      .topnav .btn:hover { background: rgba(255,255,255,.15); }

      .profile-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:36px;
  height:36px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.9);
  color:#fff;
  text-decoration:none;
  background:rgba(255,255,255,.08);
}

.profile-icon:hover{
  background:rgba(255,255,255,.18);
}

.profile-icon .pi{
  font-size:18px;
  line-height:1;
}

    
      #userEmail { color:#fff; font-weight:700; font-size:14px; }

      [data-requires-auth] { display:none; }
      [data-requires-anon] { display:inline-flex; }

      /* LOGIN-DIALOG */
      dialog {
        border: none;
        border-radius: 16px;
        padding: 0;
        width: min(420px, 92vw);
        background: #fff;
        color: #111;
        box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      }
      dialog::backdrop {
        background: rgba(0,0,0,0.45);
        backdrop-filter: blur(3px);
      }
      dialog form {
        padding: 26px 22px;
        font-family: inherit;
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      dialog label {
        display: grid;
        gap: 6px;
        margin-bottom: 12px;
        font-weight: 600;
        color: #222;
      }
      dialog input {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font: inherit;
      }
      dialog button[type="submit"] {
        padding: 10px 14px;
        border-radius: 10px;
        border: 2px solid #2e1df7;
        background: #eae7ff;
        color: #2e1df7;
        font-weight: 700;
        cursor: pointer;
      }
      #authMessage { margin-top:10px; color:#333; font-weight:600; }
    </style>

    <nav class="topnav" aria-label="Hauptnavigation">
      <a href="index.html" class="logo-link" aria-label="DigitABI Startseite">
        <img src="assets/place-holder.png"
             onerror="this.src='assets/logo-digitabi.png'; this.onerror=null;"
             alt=""
             class="nav-logo">
      </a>

      <div class="nav-links">
        <a href="index.html">Startseite</a>
        <a href="abirechner.html">Abibuch-Creator</a>
        <a href="steckbrief.html">Abibuch-Editor</a>
        <a href="index.html#mottos">Motto-Ideen</a>
        <a href="ueber-uns.html">√úber Uns</a>
        <a href="konto.html" data-requires-auth>Mein Konto</a>
      </div>

     <div class="authbox">
  <!-- Profil-Icon (nur eingeloggt sichtbar) -->
  <a href="konto.html" class="profile-icon" id="profileBtn" data-requires-auth title="Dein Profil" aria-label="Dein Profil">
    <span class="pi">üë§</span>
  </a>

  <button id="logoutBtn" class="btn" data-requires-auth>Logout</button>

  <!-- Nur ausgeloggt sichtbar -->
  <button class="btn" data-requires-anon data-action="open-auth">Login / Registrieren</button>
</div>


  
  </header>

<!-- Topnav -->

<div class="container">
  <h1>Mein Konto</h1>
  <button id="backBtn">‚Üê Zur√ºck</button>
<div class="card">
  <div class="muted">
    Eingeloggt als: <b id="kontoEmail"></b>
  </div>


    <label> Anzeigename
      <input id="displayName" placeholder="z. B. Mulan Mustermann">
    </label>

    <label> Klassen-/Jahrgangs-Code (class_id)
      <input id="classId" placeholder="z. B. abi2026-hg-b">
    </label>
<label> Passwort festlegen (f√ºr zuk√ºnftige Logins)
  <input id="newPassword" type="password" placeholder="mind. 8 Zeichen">
</label>

<button id="setPwBtn">Passwort setzen</button>

    <button id="saveBtn">Speichern</button>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div data-auth="anon">
    <p>Bitte zuerst einloggen.</p>
  </div>
</div>

 <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://xiiqcjutmvhdmmnzvciu.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_B1BShZ1r77ulTAcT8ayMdw_rON5I-O9";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Session holen + Seite sch√ºtzen
  const { data: init, error: initErr } = await supabase.auth.getSession();
  const session = init?.session;

  if (initErr || !session?.user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  const user = session.user;

  // Email anzeigen
  document.getElementById("kontoEmail").textContent = user.email;

  // Zur√ºck-Button
  document.getElementById("backBtn")?.addEventListener("click", () => history.back());

  // Profil laden
  const { data: prof } = await supabase
    .from("profiles")
    .select("display_name, class_id")
    .eq("id", user.id)
    .maybeSingle();

  if (prof) {
    document.getElementById("displayName").value = prof.display_name || "";
    document.getElementById("classId").value = prof.class_id || "";
  }

  // Profil speichern
  document.getElementById("saveBtn")?.addEventListener("click", async () => {
    const display_name = document.getElementById("displayName").value.trim();
    const class_id = document.getElementById("classId").value.trim();

    const { error } = await supabase
      .from("profiles")
      .upsert({ id: user.id, display_name, class_id }, { onConflict: "id" });

    document.getElementById("msg").textContent = error
      ? ("Fehler: " + error.message)
      : "Gespeichert ‚úÖ";
  });

  // Passwort setzen
  document.getElementById("setPwBtn")?.addEventListener("click", async () => {
    const pw = document.getElementById("newPassword").value.trim();

    if (pw.length < 8) {
      document.getElementById("msg").textContent = "Passwort muss mindestens 8 Zeichen haben.";
      return;
    }

    const { error } = await supabase.auth.updateUser({ password: pw });

    document.getElementById("msg").textContent = error
      ? ("Fehler beim Passwort setzen: " + error.message)
      : "Passwort gesetzt ‚úÖ Ab jetzt Login mit E-Mail + Passwort.";

    document.getElementById("newPassword").value = "";
  });

  // Logout
  document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "index.html";
  });
</script>

  
</body>
</html>
